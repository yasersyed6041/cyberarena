from flask import Flask, render_template, request, redirect, jsonify
from google.cloud import datastore, runtimeconfig
from utilities.vulnerabilities import get_vulnerability, assess_response
import pdfkit

app = Flask(__name__, template_folder='templates')

LEVEL1_POINTS = 15
LEVEL2_POINTS = 30

@app.route('/<workout_id>', methods=['GET', 'POST'])
def risk_assessment(workout_id):
    ds_client = datastore.Client()
    workout = ds_client.get(ds_client.key('cybergym-workout', workout_id))
    if request.method == 'POST':
        workout['assessment']['response'] = {
            'points': 0,
            'company': request.form['company'],
            'mission': request.form['mission'],
            'system': request.form['system'],
            'confidentiality_scenario': request.form['confidentiality-scenario'],
            'confidentiality_impact': request.form['confidentiality-impact'],
            'integrity_scenario': request.form['integrity-scenario'],
            'integrity_impact': request.form['integrity-impact'],
            'availability_scenario': request.form['availability-scenario'],
            'availability_impact': request.form['availability-impact'],
            'vulnerabilities': {}
        }
        ds_client.put(workout)
        return redirect(f'/get-vulnerabilities/{workout_id}')
    page_template = 'risk-workout.html'
    return render_template(page_template)


@app.route('/get-vulnerabilities/<workout_id>', methods=['GET', 'POST'])
def get_vulnerabilities(workout_id):
    level = "1"
    ds_client = datastore.Client()
    workout = ds_client.get(ds_client.key('cybergym-workout', workout_id))
    if request.method == 'POST':
        if request.form['action'] == 'next':
            cve_id = request.form['cve_id']
            vulnerability_impact = request.form['vulnerability-impact']
            impact_rationale = request.form['impact-rationale']
            assessment = assess_response(workout['assessment']['response'],
                                      workout['assessment']['response']['vulnerabilities'][cve_id],
                                      vulnerability_impact)
            workout['assessment']['response']['vulnerabilities'][cve_id]['response'] = vulnerability_impact
            workout['assessment']['response']['vulnerabilities'][cve_id]['rationale'] = impact_rationale
            workout['assessment']['response']['vulnerabilities'][cve_id]['correct'] = assessment['correct']
            workout['assessment']['response']['vulnerabilities'][cve_id]['correct_answer'] = assessment['correct_answer']
            workout['assessment']['response']['points'] += assessment['points']
            if workout['assessment']['response']['points'] >= LEVEL1_POINTS:
                level = "2"
                workout['assessment']['questions'][0]['complete'] = True
            if workout['assessment']['response']['points'] > LEVEL2_POINTS:
                workout['assessment']['questions'][1]['complete'] = True
                data = workout['assessment']['response']
                page_template = 'complete.html'
                ds_client.put(workout)
                return render_template(page_template, data=data)
            ds_client.put(workout)
        elif request.form['action'] == 'startover':
            del workout['assessment']['response']
            ds_client.put(workout)
            page_template = 'risk-workout.html'
            return redirect(f'/{workout_id}')
        elif request.form['action'] == 'complete':
            return redirect(f'/complete/{workout_id}')

    random_vuln = get_vulnerability(workout_id)
    data = {
        'level': level,
        'score': workout['assessment']['response']['points'],
        'company': workout['assessment']['response']['company'],
        'mission': workout['assessment']['response']['mission'],
        'system': workout['assessment']['response']['system'],
        'mission_confidentiality': workout['assessment']['response']['confidentiality_impact'],
        'mission_integrity': workout['assessment']['response']['integrity_impact'],
        'mission_availability': workout['assessment']['response']['availability_impact'],
        'asset': random_vuln['asset'],
        'cve_id': random_vuln['cve_id'],
        'description': random_vuln['description'],
        'attack_vector': random_vuln['attack_vector'],
        'complexity': random_vuln['complexity'],
        'priv': random_vuln['priv'],
        'v_confidentiality': random_vuln['confidentiality'],
        'v_integrity': random_vuln['integrity'],
        'v_availability': random_vuln['availability']
    }
    workout['assessment']['response']['vulnerabilities'][random_vuln['cve_id']] = {
                'asset': random_vuln['asset'],
                'description': random_vuln['description'],
                'attack_vector': random_vuln['attack_vector'],
                'complexity': random_vuln['complexity'],
                'priv': random_vuln['priv'],
                'v_confidentiality': random_vuln['confidentiality'],
                'v_integrity': random_vuln['integrity'],
                'v_availability': random_vuln['availability']
    }
    ds_client.put(workout)

    page_template = 'get-vulnerability.html'
    return render_template(page_template, data=data)


@app.route('/complete/<workout_id>', methods=['GET', 'POST'])
def complete(workout_id):
    ds_client = datastore.Client()
    workout = ds_client.get(ds_client.key('cybergym-workout', workout_id))
    data = workout['assessment']['response']
    for cve in list(data['vulnerabilities'].items()):
        key = cve[0]
        if 'response' not in data['vulnerabilities'][key]:
            del data['vulnerabilities'][key]
    if request.method == 'POST':
        if request.form['action'] == 'startover':
            del workout['assessment']['response']
            ds_client.put(workout)
            page_template = 'risk-workout.html'
            return render_template(page_template)
    page_template = 'complete.html'
    return render_template(page_template, data=data)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
