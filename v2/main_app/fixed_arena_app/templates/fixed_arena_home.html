{% extends "fa_base.html" %}
{% import 'cyber_learn_logo.html' as logo %}
{% import "vuln_macros.html" as vuln_macros %}
{% import "fixed_arena_macros.html" as fixed_arena_macros %}
{% block title %}Secure Training and Operations Center{% endblock %}
{% block nav_title %}Secure Training and Operations Center{% endblock %}
{% block styles %}
        <link rel="stylesheet" type="text/css" href="{{ url_for('fixed_arena.static', filename='css/fixed_arena_styles.css') }}">
{% endblock styles %}
{% block navbar %}
    <div class="navbar-nav mr-auto">
        <ul class="nav nav-pills top-navbar-pill">
            {% if request.endpoint.split(".")[0] == 'fixed_arena' %}
                <li class="nav-item">
                    <a href="{{ url_for('home') }}" class="nav-link text-center">Cyber Arena</a>
                </li>
            {% else %}
                <li class="nav-item">
                    <a href="{{ url_for(fixed_arena_app.home) }}" class="nav-link text-center">STOC</a>
                </li>
            {% endif %}
            <!-- TODO: if not student, button to send to teacher home -->
            <!-- TODO: if admin, button to send to admin home -->
        </ul>
    </div>
    <div class="navbar-nav ml-auto">
        <button id="contact-us" class="nav-item btn top-navbar-btn"
                data-toggle="modal" data-target="#commentsModal">Contact Us</button>
        <button id="sign-out" class="nav-item btn top-navbar-btn">Sign Out</button>
    </div> 
{% endblock %}
{% block content %}
    <script type="text/javascript" src='{{ url_for("static", filename="js/login.js") }}'></script>
    <script type="text/javascript" src="{{ url_for('fixed_arena.static', filename='js/fixed_arena_utils.js') }}"></script>
    <script>
          var teacher_email = null;
          var auth_config = {
            apiKey: '{{auth_config["api_key"]}}',
            authDomain: '{{auth_config["auth_domain"]}}',
            projectId: '{{auth_config["project_id"]}}'
          };
          initApp(auth_config).then(value => {
            enable_signout();
            if(value['admin'] === true){
              var admin_button = document.createElement("a");
              admin_button.href = "/admin/home";
              admin_button.className = "nav-link";
              admin_button.innerHTML = "Admin Page";
            }
            if(value['student'] === true){
              var student_home_link = document.createElement("a");
              student_home_link = '/student/home';
              student_home_link.className = "nav-link";
              student_home_link.innerHTML = "Your Student Page";
            }
          });
    </script>
    <div id='content-row' class='row row-offcanvas row-offcanvas-left vh-100'>
        <!--TODO: Create toggle sidebar button in top navbar -->
        <!--<div id="sidebar-div" class="col-sm-3 col-md-2 sticky-top nav-sidebar">-->
        <div id="sidebar-div" class="col-md-3 col-lg-2 sidebar-offcanvas h-100 overflow-auto nav-sidebar" role="navigation">
            <ul id="sidebar-nav" class="nav nav-pills flex-column sticky-top pl-0 mt-3" role="tablist">
                <li>{{ logo.logo_div() }}</li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="fa-home-btn" data-toggle="pill"
                            data-target="#boot-container" type="button" role="tab"
                            aria-controls="nav-boot"
                            aria-selected="true">Home</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fa-config-btn" data-toggle="pill"
                            data-target="#settings-container" type="button" role="tab"
                            aria-controls="nav-settings"
                            aria-selected="false">Manage</button>
                </li>
            </ul>
        </div> <!--End sidebar-menu div
        col-md-10 col-sm-10 col-10
        -->
        <div id="content-div" class="col main pt-5 mt-3 h-100 pr-3 overflow-auto">
            <div id="tab-container" class="tab-content">
                <div class="tab-pane fade active show" id="fa-home" role="tabpanel" aria-labelledby="fa-home-tab">
                    <div id="home-content-ctn" class="d-inline-flex">
                        <div id="stoc-table-div" class="table-responsive table-ctn col-10">
                            <table id="stoc-table" class="table table-hover text-nowrap table-large">
                                <thead>
                                    <tr id="stoc-table-headers">
                                        <th class="text-center"><input type="checkbox" class="select-all" id="stoc-select-all" value=""/></th>
                                        <th class="prevent-select text-center">STOC</th>
                                        <th class="prevent-select text-center">Class</th>
                                        <th class="prevent-select text-center">Description</th>
                                    </tr>
                                </thead>
                                <!--Each row id will be the STOC id-->
                                {% set ns = namespace(hourly_cost=0) %}
                                {% for stoc in fixed_arenas %}
                                    <tr>
                                        <td><input id="{{ stoc.key.name }}" class="stocIdRow" type="checkbox" value=""
                                        name="stoc_id"/></td>
                                        <td>{{ stoc.key.name }}</td>
                                        <td>
                                            {% if stoc.class.state == 'IN SESSION' %}
                                                <a href="/fixed-arena/class/{{ stoc.class.id }}"
                                                   class="btn-fa d-inline-flex col-5" target="_blank">
                                                    <i class="fa fa-expand"></i> View Class</a>
                                                <a href="#" class="btn-fa d-inline-flex col-5"
                                                   onclick="manage_class('2', '{{ stoc.class.id }}');"><i class="fa fa-minus-circle mr-2"></i> Delete Class</a></td>
                                            {% else %}
                                                <button type="button" class="btn btn-fa d-inline-flex col-6 newClassBtn"
                                                        data-toggle="modal" value="{{ stoc.key.name }}"
                                                        data-target="#create-class-modal"><i class="fa fa-plus-circle mr-2"></i>New Class</button>
                                            {% endif %}
                                        <td>{{ stoc.summary.description }}</td>
                                    </tr>
                                    {% set ns.hourly_cost = ns.hourly_cost + stoc.summary.hourly_cost %}
                                {% endfor %}
                                <tr>
                                    <td><input type="checkbox" value=""/></td>
                                    <td>untapped</td>
                                    <td><a href="#">Class</a>, <a href="#">New Class</a>, <a href="#">Delete Class</a></td>
                                    <td>STOC object, description, or list of fixed servers for STOC</td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" value=""/></td>
                                    <td>Forensics</td>
                                    <td><a href="#">Class</a>, <a href="#">New Class</a>, <a href="#">Delete Class</a></td>
                                    <td>STOC object, description, or list of fixed servers for STOC</td>

                                </tr>
                            </table>
                        </div><!--End stoc-table-div-->
                        <div id="cost-summary" class="card bg-light mb-3 col-3 col-sm-2">
                            <div class="card-header">Cost Summary</div>
                            <div class="card-body">
                                <h5 class="card-title">${{ ns.hourly_cost }} / hour</h5>
                            </div>
                        </div><!-- End cost-summary div-->
                        <div id="create-class-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="create-class-modal" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-slideout modal-sm" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="create-class-modal-header">Create Class</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">x</span>
                                        </button>
                                    </div> <!-- End modal-header -->
                                    <div class="modal-body">
                                        <form id="create-class-form" action="">
                                            <div class="form-group " id="stoc-id-div">
                                                <!--This div input gets filled based on row the create class button was created-->
                                            </div>
                                            <div class="form-group">
                                                <label for="classType">Class Build:</label>
                                                <select id="classType" name="build_id" required class="form-control">
                                                    {% for class_spec in class_spec_list %}
                                                        <option value="{{ class_spec }}">{{ class_spec.upper() }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="build-count">Number of workspaces:</label>
                                                <input id="build-count" name='build_count' type="number"
                                                       class="form-control" required min="1" value="1"/>
                                            </div>
                                            <div class="form-group">
                                                <label for="class-expire-date">Expires: </label>
                                                <input id="class-expire-date" class="form-control" name="expires"
                                                       type="datetime-local">
                                            </div>
                                            <div class="form-">
                                                <button type="submit" class="btn-fa w-100" id="submitCreateClass">Submit</button>
                                            </div>
                                        </form>
                                    </div> <!-- End modal-body -->
                                </div> <!-- End modal-content -->
                            </div> <!-- End modal-dialog -->
                        </div> <!-- End create-class-modal -->
                    </div><!-- End home-content-ctn-->
                </div><!--End fa-home div-->
                <div class="tab-pane fade" id="config-tab" aria-labelledby="fa-config-btn"></div><!-- End config-tab-->
            </div> <!--End tab-container div-->
            <!-- TODO: Footer is not displaying for some reason. Need to eventually discover why -->
            <footer class="footer text-center">
                <p style="padding-top: 1rem;">UA Little Rock Emerging Analytics Center</p>
                <p>This material is based upon work supported by the National Science Foundation under Grant No. 1623628</p>
            </footer>
        </div> <!-- End content div -->
    </div> <!--End content-row div-->
    <script type="text/javascript">
        // TODO: Clean up the javascript functions; Reduce the amount of $(function(){...}); declarations
        // Vulnerability Builder Functions
        var selectedTemplateID = '';
        // Handle attack template table clicks
        $('#vuln-templates-table tr').click(function () {
            var row = $(this);
            var checkmark = $(this).find('span');
            var vulnBtn = $('#vuln-template-btn');
            if (row.attr("id") !== 'vuln-table-header') {
                // Current template is deselected
                if (row.hasClass('selected')) {
                    row.removeClass('selected');
                    checkmark.removeClass('checkmark');
                    vulnBtn.prop('disabled', true);
                    vulnBtn.prop('hidden', true);
                }
                // A different row is selected
                else {
                    row.addClass('selected').siblings().removeClass('selected');
                    row.siblings().find('span').removeClass('checkmark');
                    checkmark.addClass('checkmark');
                    selectedTemplateID = row.attr('id');
                    vulnBtn.prop('disabled', false);
                    vulnBtn.prop('hidden', false);
                }
            }
        });
        $(document).on('click', '#stoc-table button.newClassBtn', function (){
            // Get target div and clear previous content
            var stocInputDiv = document.getElementById('stoc-id-div');
            stocInputDiv.innerHTML = '';

            // Create input
            let btnValue = $(this).val();
            var stocInput = document.createElement('input');
            stocInput.id = 'stocIdInput'
            stocInput.type = 'text';
            stocInput.value = btnValue;
            stocInput.name = 'stoc_id';
            stocInput.readOnly = true;
            stocInput.className = 'form-control';
            stocInput.textContent = btnValue.toUpperCase();
            var stocLabel = document.createElement('label');
            stocLabel.htmlFor = 'stocIdInput';
            stocLabel.textContent = 'STOC ID:';

            // Append elements to target div
            stocInputDiv.append(stocLabel);
            stocInputDiv.append(stocInput);
        });
        $(document).ready(function (){
           var today = new Date();
           var day = today.getDay();
           var month = today.getMonth();
           var year = today.getFullYear();
           if (day < 10) {
               day = '0' + day;
           }
           if (month < 10) {
               // Max date allowed for classes is 3 months
               if (month + 3 >= 10) {
                   month = month + 3;
               }
               else {
                   month = '0' + month;
               }
           }
           var min_date = year + '-' + month + '-' + day;
           var max_date = year + '-' + month + '-' + day;
           document.getElementById('class-expire-date').setAttribute("min", min_date);
           document.getElementById('class-expire-date').setAttribute("max", max_date);
        });
        $(document).ready(function() {
             // Send request to server for attack template and build form
            $('#vuln-template-btn').on('click', function (e) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=utf-8',
                    traditional: true,
                    url: '/teacher/api/vuln/templates/filter',
                    data: JSON.stringify({'attack_id': selectedTemplateID}),
                    dataType: 'json',
                    success: function (data) {
                        // reset selectedID value to NULL
                        build_form(data, selectedTemplateID);
                    }
                })
            });
        });

        // Network Build Functions
        var selectedBuildID = '';
        // Handle attack template table clicks
        $('#network-build-table tr').click(function () {
            var row = $(this);
            var checkmark = $(this).find('span');
            var networkBtn = $('#network-build-btn');
            if (row.attr("id") !== 'network-build-header') {
                // Current template is deselected
                if (row.hasClass('selected')) {
                    row.removeClass('selected');
                    checkmark.removeClass('checkmark');
                    networkBtn.prop('disabled', true);
                    networkBtn.prop('hidden', true);
                }
                // A different row is selected
                else {
                    if (row.hasClass('active-build')) {
                        return
                    }
                    row.addClass('selected').siblings().removeClass('selected');
                    row.siblings().find('span').removeClass('checkmark');
                    checkmark.addClass('checkmark');
                    selectedBuildID = row.attr('id');
                    networkBtn.prop('disabled', false);
                    networkBtn.prop('hidden', false);
                }
            }
        });
        $(document).ready(function() {
            // Send request to server for attack template and build form
            $('#network-build-btn').on('click', function (e) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=utf-8',
                    traditional: true,
                    url: '/teacher/api/fixed-arena/update',
                    data: JSON.stringify({'attack_id': selectedBuildID, 'network_id': 'network-adsfasdf'}),
                    dataType: 'json',
                    success: function (data) {
                        // reset selectedBuildID value to NULL
                        console.log(data);
                    }
                })
            });
        });
        $(document).ready(function(){
            $('.count').prop('disabled', true);
            $(document).on('click','.plus',function(){
                var countObj = $('#auto-shutoff-time')
                var count = countObj.val(parseInt(countObj.val()));
                console.log(count.val());
                if (count.val() < 10) {
                    countObj.val(parseInt(countObj.val()) + 1);
                    //$('.count').val(parseInt($('.count').val()) + 1);
                }
                else if (count.val() >= 10) {
                    $('.count').val('10');
                }
            });
            $(document).on('click','.minus',function(){
                var countObj = $('#auto-shutoff-time');
                countObj.val(parseInt(countObj.val()) - 1);
               //  $('.count').val(parseInt($('.count').val()) - 1 );
                if (countObj.val() == 0) {
                    countObj.val(1);
                }
            });
        });
        $('.select-all-servers').click(function(event){
            var selectState = this.checked;
            if (this.id === 'boot-select-all') {
                $('#server-table input[type="checkbox"]').prop('checked', selectState);
            }
            else if (this.id === 'manage-select-all') {
                $('#manage-server-table input[type="checkbox"]').prop('checked', selectState);
                // TODO: This isn't functioning properly
                $('#manage-server-nav:button').each(function(){ this.disabled(selectState); });
            }
        });
    </script>
{% endblock content %}
