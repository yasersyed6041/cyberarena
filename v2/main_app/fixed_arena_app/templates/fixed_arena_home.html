{% extends "fa_base.html" %}
{% import 'cyber_learn_logo.html' as logo %}
{% import "vuln_macros.html" as vuln_macros %}
{% import "fixed_arena_macros.html" as fixed_arena_macros %}
{% block title %}Secure Training and Operations Center{% endblock %}
{% block nav_title %}Secure Training and Operations Center{% endblock %}
{% block styles %}
        <link rel="stylesheet" type="text/css" href="{{ url_for('fixed_arena.static', filename='css/fixed_arena_styles.css') }}">
{% endblock styles %}
{% block navbar %}
    <div class="navbar-nav mr-auto">
        <ul class="nav nav-pills top-navbar-pill">
            {% if request.path == '/fixed-arena/home' %}
                <li class="nav-item">
                    <button class="nav-link" id="nav-boot-btn" data-toggle="pill"
                            type="button"
                            aria-selected="true">Cyber Arena</button>
                </li>
            {% else %}
                <li class="nav-item">
                <button class="nav-link" id="nav-boot-btn" data-toggle="pill"
                        type="button"
                        aria-selected="true">STOC</button>
                </li>
            {% endif %}
            <!-- TODO: if not student, button to send to teacher home -->
            <!-- TODO: if admin, button to send to admin home -->
        </ul>
    </div>
    <div class="navbar-nav ml-auto">
        <!--If signed in, display, else display Sign In Button-->
        <!--Sign out button isn't functioning properly; Returns bad jason object error-->
        <button id="contact-us" class="nav-item btn top-navbar-btn"
                data-toggle="modal" data-target="#commentsModal">Contact Us</button>
        <button id="sign-out" class="nav-item btn top-navbar-btn">Sign Out</button>
    </div> 
{% endblock %}
{% block content %}
    <script type="text/javascript" src='{{ url_for("static", filename="js/login.js") }}'></script>
    <script type="text/javascript" src="{{ url_for('fixed_arena.static', filename='js/fixed_arena_utils.js') }}"></script>
    <script>
          var teacher_email = null;
          var auth_config = {
            apiKey: '{{auth_config["api_key"]}}',
            authDomain: '{{auth_config["auth_domain"]}}',
            projectId: '{{auth_config["project_id"]}}'
          };
          initApp(auth_config).then(value => {
            enable_signout();
            if(value['admin'] === true){
              var admin_button = document.createElement("a");
              admin_button.href = "/admin/home";
              admin_button.className = "nav-link";
              admin_button.innerHTML = "Admin Page";
            }
            if(value['student'] === true){
              var student_home_link = document.createElement("a");
              student_home_link = '/student/home';
              student_home_link.className = "nav-link";
              student_home_link.innerHTML = "Your Student Page";
            }
          });
    </script>
    <div id='content-row' class='row row-offcanvas row-offcanvas-left vh-100'>
        <!--TODO: Create toggle sidebar button in top navbar -->
        <!--<div id="sidebar-div" class="col-sm-3 col-md-2 sticky-top nav-sidebar">-->
        <div id="sidebar-div" class="col-md-3 col-lg-2 sidebar-offcanvas h-100 overflow-auto nav-sidebar" role="navigation">
            <ul id="sidebar-nav" class="nav nav-pills flex-column sticky-top pl-0 mt-3" role="tablist">
                <li>{{ logo.logo_div() }}</li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="fa-home-btn" data-toggle="pill"
                            data-target="#boot-container" type="button" role="tab"
                            aria-controls="nav-boot"
                            aria-selected="true">Home</button>
                </li>
                <!-- This tab currently does nothing-->
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fa-create-lab-btn" data-toggle="pill"
                            data-target="#create-lab-container" type="button" role="tab"
                            aria-controls="nav-create-lab"
                            aria-selected="false">Create a Lab</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fa-vuln-tab" data-toggle="pill"
                            data-target="#vuln-tab" type="button" role="tab"
                            aria-controls="nav-attacks"
                            aria-selected="false">Command and Control</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fa-config-btn" data-toggle="pill"
                            data-target="#settings-container" type="button" role="tab"
                            aria-controls="nav-settings"
                            aria-selected="false">Manage</button>
                </li>
            </ul>
        </div> <!--End sidebar-menu div
        col-md-10 col-sm-10 col-10
        -->
        <div id="content-div" class="col main pt-5 mt-3 h-100 pr-3 overflow-auto">
            <div id="tab-container" class="tab-content">
                <div class="tab-pane fade active show" id="fa-home" role="tabpanel" aria-labelledby="fa-home-tab">
                    <div id="home-content-ctn">
                        <div id="stoc-table-div" class="table-responsive table-ctn">
                            <table id="stoc-table" class="table table-hover text-nowrap table-large">
                                <thead>
                                    <tr id="stoc-table-headers">
                                        <th class="text-center"><input type="checkbox" class="select-all" id="stoc-select-all" value=""/></th>
                                        <th class="prevent-select text-center">STOC</th>
                                        <th class="prevent-select text-center">Current State</th>
                                        <th class="prevent-select text-center">Action</th>
                                        <th class="prevent-select text-center">Details</th>
                                    </tr>
                                </thead>
                                <!--Each row id will be the STOC id-->
                                <tr>
                                    <td><input type="checkbox" value=""/></td>
                                    <td>cln-stoc</td>
                                    <td>STOPPED</td>
                                    <td><a href="#">Class</a>, <a href="#">New Class</a>, <a href="#">Delete Class</a></td>
                                    <td>STOC object, description, or list of fixed servers for STOC</td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" value=""/></td>
                                    <td>untapped</td>
                                    <td>NOT BUILT</td>
                                    <td><a href="#">Class</a>, <a href="#">New Class</a>, <a href="#">Delete Class</a></td>
                                    <td>STOC object, description, or list of fixed servers for STOC</td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" value=""/></td>
                                    <td>Forensics</td>
                                    <td>IN SESSION</td>
                                    <td><a href="#">Class</a>, <a href="#">New Class</a>, <a href="#">Delete Class</a></td>
                                    <td>STOC object, description, or list of fixed servers for STOC</td>

                                </tr>
                            </table>
                        </div><!--End stoc-table-div-->
                    </div><!-- End home-content-ctn-->
                </div><!--End fa-home div-->
                <div class="tab-pane fade" id="vuln-tab" aria-labelledby="fa-vuln-tab"></div><!--End vuln-tab-->
                <div class="tab-pane fade" id="config-tab" aria-labelledby="fa-config-btn"></div><!-- End config-tab-->
            </div> <!--End tab-container div-->
            <!-- TODO: Footer is not displaying for some reason. Need to eventually discover why -->
            <footer class="footer text-center">
                <p style="padding-top: 1rem;">UA Little Rock Emerging Analytics Center</p>
                <p>This material is based upon work supported by the National Science Foundation under Grant No. 1623628</p>
            </footer>
        </div> <!-- End content div -->
    </div> <!--End content-row div-->
    <script type="text/javascript">
        // Vulnerability Builder Functions
        var selectedTemplateID = '';
        // Handle attack template table clicks
        $('#vuln-templates-table tr').click(function () {
            var row = $(this);
            var checkmark = $(this).find('span');
            var vulnBtn = $('#vuln-template-btn');
            if (row.attr("id") !== 'vuln-table-header') {
                // Current template is deselected
                if (row.hasClass('selected')) {
                    row.removeClass('selected');
                    checkmark.removeClass('checkmark');
                    vulnBtn.prop('disabled', true);
                    vulnBtn.prop('hidden', true);
                }
                // A different row is selected
                else {
                    row.addClass('selected').siblings().removeClass('selected');
                    row.siblings().find('span').removeClass('checkmark');
                    checkmark.addClass('checkmark');
                    selectedTemplateID = row.attr('id');
                    vulnBtn.prop('disabled', false);
                    vulnBtn.prop('hidden', false);
                }
            }
        });
        $(document).ready(function() {
            // Send request to server for attack template and build form
            $('#vuln-template-btn').on('click', function (e) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=utf-8',
                    traditional: true,
                    url: '/teacher/api/vuln/templates/filter',
                    data: JSON.stringify({'attack_id': selectedTemplateID}),
                    dataType: 'json',
                    success: function (data) {
                        // reset selectedID value to NULL
                        build_form(data, selectedTemplateID);
                    }
                })
            });
        });

        // Network Build Functions
        var selectedBuildID = '';
        // Handle attack template table clicks
        $('#network-build-table tr').click(function () {
            var row = $(this);
            var checkmark = $(this).find('span');
            var networkBtn = $('#network-build-btn');
            if (row.attr("id") !== 'network-build-header') {
                // Current template is deselected
                if (row.hasClass('selected')) {
                    row.removeClass('selected');
                    checkmark.removeClass('checkmark');
                    networkBtn.prop('disabled', true);
                    networkBtn.prop('hidden', true);
                }
                // A different row is selected
                else {
                    if (row.hasClass('active-build')) {
                        return
                    }
                    row.addClass('selected').siblings().removeClass('selected');
                    row.siblings().find('span').removeClass('checkmark');
                    checkmark.addClass('checkmark');
                    selectedBuildID = row.attr('id');
                    networkBtn.prop('disabled', false);
                    networkBtn.prop('hidden', false);
                }
            }
        });
        $(document).ready(function() {
            // Send request to server for attack template and build form
            $('#network-build-btn').on('click', function (e) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=utf-8',
                    traditional: true,
                    url: '/teacher/api/fixed-arena/update',
                    data: JSON.stringify({'attack_id': selectedBuildID, 'network_id': 'network-adsfasdf'}),
                    dataType: 'json',
                    success: function (data) {
                        // reset selectedBuildID value to NULL
                        console.log(data);
                    }
                })
            });
        });
        $(document).ready(function(){
            $('.count').prop('disabled', true);
            $(document).on('click','.plus',function(){
                var countObj = $('#auto-shutoff-time')
                var count = countObj.val(parseInt(countObj.val()));
                console.log(count.val());
                if (count.val() < 10) {
                    countObj.val(parseInt(countObj.val()) + 1);
                    //$('.count').val(parseInt($('.count').val()) + 1);
                }
                else if (count.val() >= 10) {
                    $('.count').val('10');
                }
            });
            $(document).on('click','.minus',function(){
                var countObj = $('#auto-shutoff-time');
                countObj.val(parseInt(countObj.val()) - 1);
               //  $('.count').val(parseInt($('.count').val()) - 1 );
                if (countObj.val() == 0) {
                    countObj.val(1);
                }
            });
        });
        $('.select-all-servers').click(function(event){
            var selectState = this.checked;
            if (this.id === 'boot-select-all') {
                $('#server-table input[type="checkbox"]').prop('checked', selectState);
            }
            else if (this.id === 'manage-select-all') {
                $('#manage-server-table input[type="checkbox"]').prop('checked', selectState);
                // TODO: This isn't functioning properly
                $('#manage-server-nav:button').each(function(){ this.disabled(selectState); });
            }
        });
    </script>
{% endblock content %}
