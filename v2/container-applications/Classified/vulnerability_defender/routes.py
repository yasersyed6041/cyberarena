from flask import abort, Blueprint, render_template, request, redirect, session, url_for

from app_utilities.vulnerability_defender.vulnerabilities import Vulnerabilities
from app_utilities.vulnerability_defender.sample_systems import sample_systems
from app_utilities.gcp.datastore_manager import DataStoreManager
from app_utilities.globals import DatastoreKeyTypes

vulnerability_defender = Blueprint(
    'vulnerability_defender', __name__,
    url_prefix='/vulnerability-defender',
    static_folder="./static",
    template_folder='./templates',
)


@vulnerability_defender.route('/<workout_id>', methods=['GET', 'POST'])
def home(workout_id):
    ds = DataStoreManager(key_type=DatastoreKeyTypes.WORKOUT, key_id=workout_id)
    workout = ds.get()
    if not workout:
        return render_template('invalid_workout.html')

    workout_level = 'advanced'
    page_template = 'advanced-risk-workout-v2.html'

    if request.method == 'POST':
        selected_system = request.form['system']
        workout['assessment']['response'] = {
            'points': 0,
            'complete': False,
            'company': request.form['company'],
            'mission': request.form['mission'],
            'system': sample_systems[selected_system]["name"],
            'system_id': selected_system,
            'service': request.form.get('service', None),
            'service_impact': request.form.get('service-impact', None),
            'confidentiality_scenario': request.form.get('confidentiality-scenario', None),
            'confidentiality_impact': request.form['confidentiality-impact'],
            'integrity_scenario': request.form.get('integrity-scenario', None),
            'integrity_impact': request.form['integrity-impact'],
            'availability_scenario': request.form.get('availability-scenario', None),
            'availability_impact': request.form['availability-impact'],
            'vulnerabilities': {}
        }
        ds.put(workout)
        return redirect(url_for('vulnerability_defender.get_vulnerabilities', workout_id=workout_id))
    return render_template(page_template, sample_systems=sample_systems, workout_level=workout_level)


@vulnerability_defender.route('/vulnerabilities/<workout_id>', methods=['GET', 'POST'])
def get_vulnerabilities(workout_id):
    ds = DataStoreManager(key_type=DatastoreKeyTypes.WORKOUT, key_id=workout_id)
    workout = ds.get()
    if not workout:
        return render_template('invalid_workout.html')
    level = "1"
    vulnerabilities = Vulnerabilities()
    if request.method == 'POST':
        if request.form['action'] == 'next':
            cve_id = request.form['cve_id']
            vulnerability_impact = request.form['vulnerability-impact']
            impact_rationale = request.form['impact-rationale'] if 'impact-rationale' in request.form else None
            assessment = vulnerabilities.assess_response(workout['assessment']['response'],
                                                         workout['assessment']['response']['vulnerabilities'][cve_id],
                                                         vulnerability_impact)
            workout['assessment']['response']['vulnerabilities'][cve_id]['response'] = vulnerability_impact
            workout['assessment']['response']['vulnerabilities'][cve_id]['rationale'] = impact_rationale
            workout['assessment']['response']['vulnerabilities'][cve_id]['correct'] = assessment['correct']
            workout['assessment']['response']['vulnerabilities'][cve_id]['correct_answer'] = assessment['correct_answer']
            workout['assessment']['response']['points'] += assessment['points']
            if vulnerabilities.LEVEL1_POINTS <= workout['assessment']['response']['points'] < vulnerabilities.LEVEL2_POINTS:
                level = "2"
                workout['assessment']['questions'][0]['complete'] = True
            elif workout['assessment']['response']['points'] >= vulnerabilities.LEVEL2_POINTS:
                workout['assessment']['questions'][1]['complete'] = True
                workout['assessment']['response']['complete'] = True
                data = workout['assessment']['response']
                page_template = 'complete.html'
                ds.put(workout)
                return render_template(page_template, data=data)
            ds.put(workout)
        elif request.form['action'] == 'startover':
            del workout['assessment']['response']
            ds.put(workout)
            page_template = 'risk-workout.html'
            return redirect(url_for('vulnerability_defender.home', workout_id=workout_id))
        elif request.form['action'] == 'complete':
            return redirect(url_for('vulnerability_defender.complete', workout_id=workout_id))
    random_vuln = vulnerabilities.get(workout_id)
    if not random_vuln:
        return render_template('invalid_workout.html')
    data = {
        'level': level,
        'score_img': vulnerabilities.get_score_image(workout['assessment']['response']['points']),
        'score': workout['assessment']['response']['points'],
        'company': workout['assessment']['response']['company'],
        'mission': workout['assessment']['response']['mission'],
        'system': workout['assessment']['response']['system'],
        'service_impact': workout['assessment']['response']['service_impact'],
        'mission_confidentiality': workout['assessment']['response']['confidentiality_impact'],
        'mission_integrity': workout['assessment']['response']['integrity_impact'],
        'mission_availability': workout['assessment']['response']['availability_impact'],
        'asset': random_vuln['asset'],
        'cve_id': random_vuln['cve_id'],
        'description': random_vuln['description'],
        'attack_vector': random_vuln['attack_vector'],
        'complexity': random_vuln['complexity'],
        'priv': random_vuln['priv'],
        'v_confidentiality': random_vuln['confidentiality'],
        'v_integrity': random_vuln['integrity'],
        'v_availability': random_vuln['availability']
    }
    workout['assessment']['response']['vulnerabilities'][random_vuln['cve_id']] = {
        'asset': random_vuln['asset'],
        'description': random_vuln['description'],
        'attack_vector': random_vuln['attack_vector'],
        'complexity': random_vuln['complexity'],
        'priv': random_vuln['priv'],
        'v_confidentiality': random_vuln['confidentiality'],
        'v_integrity': random_vuln['integrity'],
        'v_availability': random_vuln['availability']
    }
    ds.put(workout)
    page_template = 'get-vulnerability-v2.html'
    return render_template(page_template, data=data)


@vulnerability_defender.route('/complete/<workout_id>', methods=['GET', 'POST'])
def complete(workout_id):
    page_template = 'complete-v2.html'
    ds = DataStoreManager(key_type=DatastoreKeyTypes.WORKOUT, key_id=workout_id)
    if workout := ds.get():
        data = workout['assessment'].get('response', None)
        if data:
            for cve in list(data['vulnerabilities'].items()):
                key = cve[0]
                if 'response' not in data['vulnerabilities'][key]:
                    del data['vulnerabilities'][key]
        if request.method == 'POST':
            if request.form['action'] == 'startover':
                del workout['assessment']['response']
                ds.put(workout)
                return redirect(url_for('vulnerability_defender.home', workout_id=workout_id))
        return render_template(page_template, workout=workout, data=data)
    return abort(404)
