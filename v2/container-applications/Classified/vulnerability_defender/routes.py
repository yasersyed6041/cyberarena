from flask import abort, Blueprint, render_template, request, redirect, session, url_for
import requests

from app_utilities.vulnerability_defender.vulnerabilities import Vulnerabilities
from app_utilities.vulnerability_defender.sample_systems import sample_systems
from app_utilities.gcp.datastore_manager import DataStoreManager
from app_utilities.gcp.cloud_env import CloudEnv
from app_utilities.globals import DatastoreKeyTypes

vulnerability_defender = Blueprint(
    'vulnerability_defender', __name__,
    url_prefix='/vulnerability-defender',
    static_folder="./static",
    template_folder='./templates',
)


@vulnerability_defender.route('/<workout_id>', methods=['GET', 'POST'])
def home(workout_id):
    ds = DataStoreManager(key_type=DatastoreKeyTypes.WORKOUT, key_id=workout_id)
    workout = ds.get()
    if not workout:
        return render_template('invalid_workout.html')

    workout_level = 'advanced'
    page_template = 'advanced-risk-workout-v2.html'
    assessment = Vulnerabilities().get_assessment(workout)

    if request.method == 'POST':
        selected_system = request.form['system']
        assessment['response'] = {
            'points': 0,
            'complete': False,
            'company': request.form['company'],
            'mission': request.form['mission'],
            'system': sample_systems[selected_system]["name"],
            'system_id': selected_system,
            'service': request.form.get('service', None),
            'service_impact': request.form.get('service-impact', None),
            'confidentiality_scenario': request.form.get('confidentiality-scenario', None),
            'confidentiality_impact': request.form['confidentiality-impact'],
            'integrity_scenario': request.form.get('integrity-scenario', None),
            'integrity_impact': request.form['integrity-impact'],
            'availability_scenario': request.form.get('availability-scenario', None),
            'availability_impact': request.form['availability-impact'],
            'vulnerabilities': {}
        }
        ds.put(workout)
        return redirect(url_for('vulnerability_defender.get_vulnerabilities', workout_id=workout_id))
    return render_template(page_template, sample_systems=sample_systems, workout_level=workout_level,
                           assessment=assessment)


@vulnerability_defender.route('/vulnerabilities/<workout_id>', methods=['GET', 'POST'])
def get_vulnerabilities(workout_id):
    env = CloudEnv()
    ds = DataStoreManager(key_type=DatastoreKeyTypes.WORKOUT, key_id=workout_id)
    workout = ds.get()
    if not workout:
        return render_template('invalid_workout.html')
    vulnerabilities = Vulnerabilities()
    assessment = vulnerabilities.get_assessment(workout)
    if assessment['questions'][0]['complete']:
        level = '2'
    else:
        level = '1'
    if request.method == 'POST':
        put_url = f'https://{env.main_app_v2_url}/api/unit/workout/{workout_id}'
        # put_url = f'http://localhost:5000/api/unit/workout/{workout_id}'
        if request.form['action'] == 'next':
            cve_id = request.form['cve_id']
            vulnerability_impact = request.form['vulnerability-impact']
            impact_rationale = request.form['impact-rationale'] if 'impact-rationale' in request.form else None
            progress = vulnerabilities.assess_response(assessment['response'],
                                                       assessment['response']['vulnerabilities'][cve_id],
                                                       vulnerability_impact)
            assessment['response']['vulnerabilities'][cve_id]['response'] = vulnerability_impact
            assessment['response']['vulnerabilities'][cve_id]['rationale'] = impact_rationale
            assessment['response']['vulnerabilities'][cve_id]['correct'] = progress['correct']
            assessment['response']['vulnerabilities'][cve_id]['correct_answer'] = progress['correct_answer']
            assessment['response']['points'] += progress['points']
            if vulnerabilities.LEVEL1_POINTS <= assessment['response']['points'] < vulnerabilities.LEVEL2_POINTS:
                level = "2"
                if not assessment['questions'][0]['complete']:
                    assessment['questions'][0]['complete'] = True
                    requests.put(put_url, json={'question_key': assessment['questions'][0]['question_key']})
            elif assessment['response']['points'] >= vulnerabilities.LEVEL2_POINTS:
                if not assessment['questions'][1]['complete']:
                    requests.put(put_url, json={'question_key': assessment['questions'][1]['question_key']})
                    assessment['questions'][1]['complete'] = True
                    assessment['response']['complete'] = True
                    ds.put(workout)
                data = assessment['response']
                page_template = 'complete-v2.html'
                return render_template(page_template, data=data, assessment=assessment, workout=workout)
            ds.put(workout)
        elif request.form['action'] == 'startover':
            del assessment['response']
            assessment['questions'][0]['complete'], assessment['questions'][1]['complete'] = False
            ds.put(workout)
            return redirect(url_for('vulnerability_defender.home', workout_id=workout_id))
        elif request.form['action'] == 'complete':
            return redirect(url_for('vulnerability_defender.complete', workout_id=workout_id))
    random_vuln = vulnerabilities.get(workout_id)
    if not random_vuln:
        return render_template('invalid_workout.html')
    data = {
        'level': level,
        'score_img': vulnerabilities.get_score_image(assessment['response']['points']),
        'score': assessment['response']['points'],
        'company': assessment['response']['company'],
        'mission': assessment['response']['mission'],
        'system': assessment['response']['system'],
        'service_impact': assessment['response']['service_impact'],
        'mission_confidentiality': assessment['response']['confidentiality_impact'],
        'mission_integrity': assessment['response']['integrity_impact'],
        'mission_availability': assessment['response']['availability_impact'],
        'asset': random_vuln['asset'],
        'cve_id': random_vuln['cve_id'],
        'description': random_vuln['description'],
        'attack_vector': random_vuln['attack_vector'],
        'complexity': random_vuln['complexity'],
        'priv': random_vuln['priv'],
        'v_confidentiality': random_vuln['confidentiality'],
        'v_integrity': random_vuln['integrity'],
        'v_availability': random_vuln['availability']
    }
    assessment['response']['vulnerabilities'][random_vuln['cve_id']] = {
        'asset': random_vuln['asset'],
        'description': random_vuln['description'],
        'attack_vector': random_vuln['attack_vector'],
        'complexity': random_vuln['complexity'],
        'priv': random_vuln['priv'],
        'v_confidentiality': random_vuln['confidentiality'],
        'v_integrity': random_vuln['integrity'],
        'v_availability': random_vuln['availability']
    }
    ds.put(workout)
    page_template = 'get-vulnerability-v2.html'
    return render_template(page_template, data=data, assessment=assessment)


@vulnerability_defender.route('/complete/<workout_id>', methods=['GET', 'POST'])
def complete(workout_id):
    page_template = 'complete-v2.html'
    ds = DataStoreManager(key_type=DatastoreKeyTypes.WORKOUT, key_id=workout_id)
    if workout := ds.get():
        assessment = Vulnerabilities().get_assessment(workout=workout)
        data = assessment.get('response', None)
        if data:
            for cve in list(data['vulnerabilities'].items()):
                key = cve[0]
                if 'response' not in data['vulnerabilities'][key]:
                    del data['vulnerabilities'][key]
        if request.method == 'POST':
            if request.form['action'] == 'startover':
                del assessment['response']
                assessment['questions'][0]['complete'], assessment['questions'][1]['complete'] = False
                ds.put(workout)
                return redirect(url_for('vulnerability_defender.home', workout_id=workout_id))
        return render_template(page_template, workout=workout, data=data, assessment=assessment)
    return abort(404)

